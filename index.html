<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å°å°ç”Ÿæ€å­¦å®¶ï¼šé£Ÿç‰©é“¾è§‚å¯Ÿè®°å½•ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Arial Rounded MT Bold','Segoe UI','Microsoft YaHei',sans-serif}
    :root{
      --primary:#4a6fa5;
      --secondary:#6bbf59;
      --accent:#ff9e4a;
      --light:#f5f7fa;
      --dark:#2c3e50;
      --shadow:0 4px 6px rgba(0,0,0,.1)
    }
    body{
      background:linear-gradient(135deg,#e0f7fa 0%,#bbdefb 100%);
      color:var(--dark);
      min-height:100vh;
      padding:20px
    }
    .container{max-width:1200px;margin:0 auto}
    header{
      text-align:center;
      margin-bottom:30px;
      padding:20px;
      background:#fff;
      border-radius:15px;
      box-shadow:var(--shadow)
    }
    h1{color:var(--primary);margin-bottom:10px;font-size:2.2rem}
    .subtitle{color:var(--dark);font-size:1.1rem}

    .tab-container{display:flex;justify-content:center;margin-bottom:30px}
    .tab{
      padding:12px 26px;
      background:#fff;
      border:none;
      border-radius:10px 10px 0 0;
      font-size:1.1rem;
      font-weight:bold;
      cursor:pointer;
      transition:.3s;
      box-shadow:var(--shadow);
      margin:0 5px
    }
    .tab.active{background:var(--primary);color:#fff}
    .tab-content{
      display:none;
      background:#fff;
      border-radius:15px;
      padding:24px;
      box-shadow:var(--shadow);
      min-height:480px
    }
    .tab-content.active{display:block}

    /* æ –æ¯åœ°æ ‡é¢˜ */
    .habitat-title {
      font-size: 1.8rem;
      font-weight: 900;
      text-align: center;
      padding: 15px;
      margin: 20px 0 15px 0;
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 3px solid;
    }
    .forest-title {
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      color: #2e7d32;
      border-color: #4caf50;
    }
    .grassland-title {
      background: linear-gradient(135deg, #fff9c4, #fff176);
      color: #f57f17;
      border-color: #ff9800;
    }
    .river-title {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      color: #1565c0;
      border-color: #2196f3;
    }

    .form-title{
      color:var(--primary);
      margin-bottom:10px;
      display:flex;
      align-items:center;
      font-size:1.3rem
    }
    .form-title i{margin-right:10px;font-size:1.5rem}
    .instruction{
      text-align:center;
      margin-bottom:20px;
      font-size:1.05rem;
      color:var(--dark);
      background:var(--light);
      padding:12px;
      border-radius:10px
    }

    /* æ‹–æ‹½æ¨¡å—åŒº - æŒ‰æ –æ¯åœ°åˆ†ç»„ */
    .habitat-palette-container {
      margin-bottom: 25px;
      padding: 15px;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }
    .forest-palette { background: #f1f8e9; border: 2px solid #c5e1a5; }
    .grassland-palette { background: #fffde7; border: 2px solid #fff59d; }
    .river-palette { background: #e8f5fd; border: 2px solid #90caf9; }

    .palette{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:14px;
      padding:10px;
      border-radius:12px;
      border:2px dashed #bbdefb
    }
    .palette.locked,
    .canvas.locked{
      pointer-events:none;
      opacity:.5
    }
    .block{
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:1px solid #d1d5db;
      box-shadow:var(--shadow);
      cursor:grab;
      user-select:none;
      font-size:0.95rem;
      display:inline-flex;
      align-items:center;
      gap:4px;
      white-space:nowrap
    }
    .block.species{
      background:#fef9c3;
      border-color:#facc15;
      font-weight:500
    }
    .block.arrow{
      background:#e0f2fe;
      border-color:#38bdf8;
      font-weight:700
    }

    /* æäº¤åŒºåŸŸï¼šæ¯ä¸ªæ –æ¯åœ°ä¸¤ä¸ªæ¡† */
    .habitat-area {
      margin-bottom: 30px;
    }
    .submission-area{
      border:2px solid #e5e7eb;
      border-radius:12px;
      padding:14px;
      background:#f9fafb;
      margin-top:14px;
      transition:.2s;
    }
    .submission-area.active{
      border-color:var(--primary);
      box-shadow:0 0 0 2px rgba(74,111,165,.25);
      background:#eff6ff;
    }
    .submission-area h3{
      margin-bottom:8px;
      font-size:1.05rem;
      color:var(--primary);
    }

    .canvas{
      margin-top:4px;
      min-height:48px;
      padding:8px 12px;
      border-radius:12px;
      border:2px dashed #9ca3af;
      background:#fffbea;
      display:flex;
      flex-wrap:nowrap;
      align-items:center;
      gap:6px;
      overflow-x:auto;
    }
    .canvas.empty::before{
      content:"æŠŠä¸Šé¢çš„å°åŠ¨ç‰©å’Œç®­å¤´æ‹–åˆ°è¿™é‡Œï¼Œæ‹¼æˆä¸€æ¡é£Ÿç‰©é“¾";
      color:#9ca3af;
      font-size:0.95rem;
      white-space:nowrap;
    }

    .controls{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px
    }
    button.btn{
      padding:6px 12px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:0.9rem;
      font-weight:bold;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:var(--shadow);
      color:#fff;
      transition:.2s;
    }
    button.btn-primary{background:var(--primary)}
    button.btn-secondary{background:#6b7280}
    button.btn-danger{background:#e74c3c}
    button.btn-success{background:#16a34a}

    button.btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      box-shadow:none
    }

    .current-chain{
      margin-top:6px;
      font-size:0.95rem
    }
    .current-chain span.value{font-weight:bold;color:#111827}
    .tip{font-size:0.85rem;color:#6b7280;margin-top:2px}

    /* æ•™å¸ˆç«¯ */
    .teacher-controls{
      display:flex;
      justify-content:flex-end;
      gap:12px;
      margin-bottom:16px
    }
    .teacher-btn{
      padding:8px 14px;
      border-radius:999px;
      border:none;
      font-size:0.95rem;
      font-weight:bold;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:var(--light);
      box-shadow:var(--shadow)
    }
    .teacher-btn.refresh{color:var(--primary)}
    .teacher-btn.clear{color:#e74c3c}

    .stats-container{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:16px;
      margin-bottom:18px
    }
    .stat-card{
      background:var(--light);
      border-radius:10px;
      padding:14px;
      text-align:center;
      box-shadow:var(--shadow)
    }
    .stat-title{font-size:0.95rem;color:#4b5563}
    .stat-value{
      font-size:2.5rem;
      font-weight:bold;
      color:var(--primary);
      margin:6px 0
    }

    .summary-box{
      background:#fff;
      border-radius:10px;
      padding:16px;
      box-shadow:var(--shadow)
    }
    .summary-title{
      font-size:1.1rem;
      color:var(--primary);
      margin-bottom:10px;
      display:flex;
      align-items:center;
      gap:6px
    }
    /* æ –æ¯åœ°æ±‡æ€»æ ‡é¢˜ */
    .habitat-summary-title {
      font-size: 1.3rem;
      font-weight: bold;
      padding: 10px 15px;
      margin: 15px 0 10px 0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .forest-summary { background: #e8f5e9; color: #2e7d32; border-left: 5px solid #4caf50; }
    .grassland-summary { background: #fffde7; color: #f57f17; border-left: 5px solid #ff9800; }
    .river-summary { background: #e8f5fd; color: #1565c0; border-left: 5px solid #2196f3; }
    
    .habitat-summary-list{
      margin-left:30px;
      margin-bottom:20px;
    }
    .habitat-summary-list li{
      margin:6px 0;
      font-size:1.2rem;
      font-weight:bold;
      color:#2c3e50;
      line-height:1.4;
      background:#fff;
      padding:8px 12px;
      border-radius:8px;
      box-shadow:0 2px 4px rgba(0,0,0,0.05);
      transition:all 0.2s ease;
    }
    .habitat-summary-list li:hover{
      background:#f0f7ff;
      transform:translateX(4px);
      box-shadow:0 4px 8px rgba(0,0,0,0.1);
    }
    .no-data{
      text-align:center;
      padding:40px;
      color:#666;
      font-size:1.05rem
    }

    .toast-message{
      position:fixed;
      left:50%;
      top:12px;
      transform:translateX(-50%);
      padding:8px 16px;
      border-radius:999px;
      font-size:0.95rem;
      font-weight:bold;
      color:#155724;
      background:#d4edda;
      box-shadow:var(--shadow);
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease;
      z-index:1000
    }
    .toast-message.error{
      background:#f8d7da;
      color:#721c24
    }
    .toast-message.show{opacity:1}

    @media (max-width:768px){
      .stats-container{grid-template-columns:1fr}
      .tab{padding:10px 18px;font-size:1rem}
      .teacher-controls{justify-content:center}
      .habitat-title { font-size: 1.5rem; padding: 12px; }
      .habitat-summary-title { font-size: 1.2rem; }
      .habitat-summary-list li { font-size: 1.1rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-paw"></i> é£Ÿç‰©é“¾è§‚å¯Ÿè®°å½•ç³»ç»Ÿ</h1>
      <p class="subtitle">æŒ‰ç…§è€å¸ˆçš„è¦æ±‚ï¼Œæ¯ç»„æ¢ç´¢å…¶ä¸­ä¸€ä¸ªæ –æ¯åœ°ï¼Œçœ‹çœ‹å¤§å®¶å¯ä»¥æ‹¼å‡ºå“ªäº›é£Ÿç‰©é“¾ï¼å‹æƒ…æé†’:ä¸€å®šè¦å…ˆæ‰¾å‡†ä½ ä»¬è¦ç ”ç©¶çš„æ –æ¯åœ°ï¼Œå†å¼€å§‹æ‹¼å“¦ï¼</p>
    </header>

    <div class="tab-container">
      <button class="tab active" data-tab="student">å­¦ç”Ÿæ“ä½œ</button>
      <button class="tab" data-tab="teacher">æ•™å¸ˆå¤§å±</button>
    </div>

    <!-- å­¦ç”Ÿå¡«å†™ -->
    <div id="student" class="tab-content active">
      <div class="student-form">
        <h2 class="form-title"><i class="fas fa-seedling"></i> æ‹¼ä¸€æ‹¼</h2>
        <div class="instruction">
          ç‚¹å‡»æ¨¡å—å³å¯æ·»åŠ åˆ°æŸä¸€è¡Œçš„é»„è‰²åŒºåŸŸï¼Œæ‹¼å‡ºä¸€æ¡å®Œæ•´é£Ÿç‰©é“¾ã€‚æ¯æ‹¼å‡ºä¸€æ¡æäº¤ä¸€æ¬¡ï¼Œæ¯ç»„æœ€å¤šæäº¤ä¸¤æ¡ã€‚
        </div>

        <!-- æ£®æ—æ –æ¯åœ° -->
        <div class="habitat-title forest-title">
          <i class="fas fa-tree"></i> æ£®æ—æ –æ¯åœ°
        </div>
        <div class="habitat-palette-container forest-palette">
          <div class="palette" id="palette-forest"></div>
        </div>
        
        <div class="habitat-area">
          <div class="submission-area active" id="area-forest-1">
            <h3>æ£®æ—é£Ÿç‰©é“¾ 1</h3>
            <div class="canvas empty" id="canvas-forest-1"></div>
            <div class="controls">
              <button class="btn btn-secondary" id="undoBtn-forest-1">
                <i class="fas fa-undo"></i> æ’¤å›
              </button>
              <button class="btn btn-danger" id="clearBtn-forest-1">
                <i class="fas fa-broom"></i> æ¸…ç©º
              </button>
              <button class="btn btn-primary" id="submitBtn-forest-1">
                <i class="fas fa-paper-plane"></i> æäº¤
              </button>
            </div>
            <div class="current-chain">
              å½“å‰é£Ÿç‰©é“¾ï¼š<span class="value" id="currentChain-forest-1">ï¼ˆè¿˜æ²¡æœ‰å“¦ï¼‰</span>
            </div>
            <div class="tip" id="submitHint-forest-1">
              çŠ¶æ€ï¼šè¿˜æœªæäº¤ã€‚
            </div>
          </div>

          <div class="submission-area" id="area-forest-2">
            <h3>æ£®æ—é£Ÿç‰©é“¾ 2</h3>
            <div class="canvas empty" id="canvas-forest-2"></div>
            <div class="controls">
              <button class="btn btn-secondary" id="undoBtn-forest-2">
                <i class="fas fa-undo"></i> æ’¤å›
              </button>
              <button class="btn btn-danger" id="clearBtn-forest-2">
                <i class="fas fa-broom"></i> æ¸…ç©º
              </button>
              <button class="btn btn-primary" id="submitBtn-forest-2">
                <i class="fas fa-paper-plane"></i> æäº¤
              </button>
            </div>
            <div class="current-chain">
              å½“å‰é£Ÿç‰©é“¾ï¼š<span class="value" id="currentChain-forest-2">ï¼ˆè¿˜æ²¡æœ‰å“¦ï¼‰</span>
            </div>
            <div class="tip" id="submitHint-forest-2">
              çŠ¶æ€ï¼šè¿˜æœªæäº¤ã€‚
            </div>
          </div>
        </div>

        <!-- è‰åŸæ –æ¯åœ° -->
        <div class="habitat-title grassland-title">
          <i class="fas fa-seedling"></i> è‰åŸæ –æ¯åœ°
        </div>
        <div class="habitat-palette-container grassland-palette">
          <div class="palette" id="palette-grassland"></div>
        </div>
        
        <div class="habitat-area">
          <div class="submission-area active" id="area-grassland-1">
            <h3>è‰åŸé£Ÿç‰©é“¾ 1</h3>
            <div class="canvas empty" id="canvas-grassland-1"></div>
            <div class="controls">
              <button class="btn btn-secondary" id="undoBtn-grassland-1">
                <i class="fas fa-undo"></i> æ’¤å›
              </button>
              <button class="btn btn-danger" id="clearBtn-grassland-1">
                <i class="fas fa-broom"></i> æ¸…ç©º
              </button>
              <button class="btn btn-primary" id="submitBtn-grassland-1">
                <i class="fas fa-paper-plane"></i> æäº¤
              </button>
            </div>
            <div class="current-chain">
              å½“å‰é£Ÿç‰©é“¾ï¼š<span class="value" id="currentChain-grassland-1">ï¼ˆè¿˜æ²¡æœ‰å“¦ï¼‰</span>
            </div>
            <div class="tip" id="submitHint-grassland-1">
              çŠ¶æ€ï¼šè¿˜æœªæäº¤ã€‚
            </div>
          </div>

          <div class="submission-area" id="area-grassland-2">
            <h3>è‰åŸé£Ÿç‰©é“¾ 2</h3>
            <div class="canvas empty" id="canvas-grassland-2"></div>
            <div class="controls">
              <button class="btn btn-secondary" id="undoBtn-grassland-2">
                <i class="fas fa-undo"></i> æ’¤å›
              </button>
              <button class="btn btn-danger" id="clearBtn-grassland-2">
                <i class="fas fa-broom"></i> æ¸…ç©º
              </button>
              <button class="btn btn-primary" id="submitBtn-grassland-2">
                <i class="fas fa-paper-plane"></i> æäº¤
              </button>
            </div>
            <div class="current-chain">
              å½“å‰é£Ÿç‰©é“¾ï¼š<span class="value" id="currentChain-grassland-2">ï¼ˆè¿˜æ²¡æœ‰å“¦ï¼‰</span>
            </div>
            <div class="tip" id="submitHint-grassland-2">
              çŠ¶æ€ï¼šè¿˜æœªæäº¤ã€‚
            </div>
          </div>
        </div>

        <!-- æ²³æµæ –æ¯åœ° -->
        <div class="habitat-title river-title">
          <i class="fas fa-water"></i> æ²³æµæ –æ¯åœ°
        </div>
        <div class="habitat-palette-container river-palette">
          <div class="palette" id="palette-river"></div>
        </div>
        
        <div class="habitat-area">
          <div class="submission-area active" id="area-river-1">
            <h3>æ²³æµé£Ÿç‰©é“¾ 1</h3>
            <div class="canvas empty" id="canvas-river-1"></div>
            <div class="controls">
              <button class="btn btn-secondary" id="undoBtn-river-1">
                <i class="fas fa-undo"></i> æ’¤å›
              </button>
              <button class="btn btn-danger" id="clearBtn-river-1">
                <i class="fas fa-broom"></i> æ¸…ç©º
              </button>
              <button class="btn btn-primary" id="submitBtn-river-1">
                <i class="fas fa-paper-plane"></i> æäº¤
              </button>
            </div>
            <div class="current-chain">
              å½“å‰é£Ÿç‰©é“¾ï¼š<span class="value" id="currentChain-river-1">ï¼ˆè¿˜æ²¡æœ‰å“¦ï¼‰</span>
            </div>
            <div class="tip" id="submitHint-river-1">
              çŠ¶æ€ï¼šè¿˜æœªæäº¤ã€‚
            </div>
          </div>

          <div class="submission-area" id="area-river-2">
            <h3>æ²³æµé£Ÿç‰©é“¾ 2</h3>
            <div class="canvas empty" id="canvas-river-2"></div>
            <div class="controls">
              <button class="btn btn-secondary" id="undoBtn-river-2">
                <i class="fas fa-undo"></i> æ’¤å›
              </button>
              <button class="btn btn-danger" id="clearBtn-river-2">
                <i class="fas fa-broom"></i> æ¸…ç©º
              </button>
              <button class="btn btn-primary" id="submitBtn-river-2">
                <i class="fas fa-paper-plane"></i> æäº¤
              </button>
            </div>
            <div class="current-chain">
              å½“å‰é£Ÿç‰©é“¾ï¼š<span class="value" id="currentChain-river-2">ï¼ˆè¿˜æ²¡æœ‰å“¦ï¼‰</span>
            </div>
            <div class="tip" id="submitHint-river-2">
              çŠ¶æ€ï¼šè¿˜æœªæäº¤ã€‚
            </div>
          </div>
        </div>

        <div class="tip" style="margin-top:10px;">
          å»ºè®®ï¼šä¸€æ¡é£Ÿç‰©é“¾ä¸€èˆ¬æœ‰ 3ï½4 ä¸ªç”Ÿç‰©ï¼Œæœ€å¤šä¸è¶…è¿‡ 5 ä¸ªã€‚
        </div>
      </div>
    </div>

    <!-- æ•™å¸ˆæŸ¥çœ‹ -->
    <div id="teacher" class="tab-content">
      <div class="teacher-dashboard">
        <div class="teacher-controls">
          <button class="teacher-btn refresh" id="refresh-btn">
            <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•°æ®
          </button>
          <button class="teacher-btn clear" id="clear-btn">
            <i class="fas fa-trash-alt"></i> æ¸…ç©ºæ•°æ®
          </button>
        </div>

        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-title">æ€»æäº¤æ¡æ•°</div>
            <div class="stat-value" id="total-submissions">0</div>
            <div class="stat-desc">æ‰€æœ‰å­¦ç”Ÿæäº¤çš„è®°å½•</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">ä¸åŒé£Ÿç‰©é“¾æ¡æ•°</div>
            <div class="stat-value" id="unique-chains">0</div>
            <div class="stat-desc">å»é‡åçš„ç­”æ¡ˆç§ç±»</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">ä»Šæ—¥æäº¤</div>
            <div class="stat-value" id="today-submissions">0</div>
            <div class="stat-desc">ä»Šå¤©è¯¾å ‚å†…çš„è®°å½•</div>
          </div>
        </div>

        <div class="summary-box">
          <div class="summary-title">
            <i class="fas fa-list-ol"></i> å…¨ç­é£Ÿç‰©é“¾æ±‡æ€»ï¼ˆæŒ‰æ –æ¯åœ°ï¼‰
          </div>
          
          <!-- æ£®æ—æ –æ¯åœ°æ±‡æ€» -->
          <div id="forest-summary">
            <div class="habitat-summary-title forest-summary">
              <i class="fas fa-tree"></i> æ£®æ—æ –æ¯åœ°é£Ÿç‰©é“¾æ±‡æ€»
            </div>
            <ol class="habitat-summary-list" id="summaryList-forest"></ol>
          </div>
          
          <!-- è‰åŸæ –æ¯åœ°æ±‡æ€» -->
          <div id="grassland-summary">
            <div class="habitat-summary-title grassland-summary">
              <i class="fas fa-seedling"></i> è‰åŸæ –æ¯åœ°é£Ÿç‰©é“¾æ±‡æ€»
            </div>
            <ol class="habitat-summary-list" id="summaryList-grassland"></ol>
          </div>
          
          <!-- æ²³æµæ –æ¯åœ°æ±‡æ€» -->
          <div id="river-summary">
            <div class="habitat-summary-title river-summary">
              <i class="fas fa-water"></i> æ²³æµæ –æ¯åœ°é£Ÿç‰©é“¾æ±‡æ€»
            </div>
            <ol class="habitat-summary-list" id="summaryList-river"></ol>
          </div>
          
          <div class="no-data" id="noDataTip" style="display:none;">
            <i class="fas fa-clipboard-list" style="font-size:2.2rem;margin-bottom:10px;"></i>
            <p>è¿˜æ²¡æœ‰å­¦ç”Ÿæäº¤é£Ÿç‰©é“¾å“¦ï½</p>
            <p style="margin-top:8px;font-size:0.95rem;">ç­‰ä¸€ç­‰ï¼Œæˆ–è€…æé†’å¤§å®¶ç‚¹å‡»"æäº¤"ã€‚</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- é¡¶éƒ¨çŠ¶æ€æç¤º -->
  <div class="toast-message" id="toast"></div>

  <script type="module">
    /************ 1ï¼‰åˆå§‹åŒ– Supabase ************/
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://fdgprrtllwycykgulbnz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZ3BycnRsbHd5Y3lrZ3VsYm56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1Mjg4MDksImV4cCI6MjA3ODEwNDgwOX0.tWyXbTgj9XnKcFqo9qmKw-u6WRTJoGBCkDswi3ZwBRU";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const TABLE_NAME = "foodchains";

    /************ 2ï¼‰UIï¼šæ ‡ç­¾åˆ‡æ¢ ************/
    document.querySelectorAll('.tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    /************ 3ï¼‰å­¦ç”Ÿç«¯ï¼šä¸‰ä¸ªæ –æ¯åœ°ï¼Œæ¯ä¸ªæ –æ¯åœ°ä¸¤ä¸ªæ¡† + æ‹–æ‹½ / ç‚¹å‡» ************/
    // å®šä¹‰ä¸‰ä¸ªæ –æ¯åœ°çš„ç‰©ç§
    const speciesList = {
      forest: ["ğŸŒ³æ ‘æœ¨","ğŸŒ±é’è‰","ğŸ¦Œé¹¿","ğŸºç‹¼","ğŸ°å…”å­","ğŸ¦Šç‹ç‹¸","ğŸ¦…è€é¹°"],
      grassland: ["ğŸŒ¾ç‹—å°¾è‰","ğŸ¦—è—è™«","ğŸç”°é¼ ","ğŸè›‡","ğŸ¦‰çŒ«å¤´é¹°"],
      river: ["ğŸŒ¿èŠ¦è‹‡","ğŸƒæµ®è","ğŸ¦æ²³è™¾","ğŸŸå°é±¼","ğŸ¦†æ°´é¸Ÿ","ğŸŠé³„é±¼"]
    };
    
    const arrowList = ["â†’","â†"];

    const toastEl = document.getElementById("toast");
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    // æ¯ä¸ªæ –æ¯åœ°æ¯ä¸ªæ¡†çš„çŠ¶æ€ç®¡ç†
    const areaStates = {
      'forest-1': { hasSubmitted: false, isSubmitting: false },
      'forest-2': { hasSubmitted: false, isSubmitting: false },
      'grassland-1': { hasSubmitted: false, isSubmitting: false },
      'grassland-2': { hasSubmitted: false, isSubmitting: false },
      'river-1': { hasSubmitted: false, isSubmitting: false },
      'river-2': { hasSubmitted: false, isSubmitting: false }
    };

    // å½“å‰æ¿€æ´»çš„æ˜¯å“ªä¸ªæ¡†ï¼ˆæ‰‹æœºç‚¹å‡»æ¨¡å—æ—¶ç”¨ï¼‰
    let activeCanvasId = 'forest-1';

    function showToast(msg, type="success"){
      toastEl.textContent = msg;
      toastEl.classList.remove("error");
      if(type==="error") toastEl.classList.add("error");
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    function createPaletteBlock(label, type, habitat){
      const div = document.createElement("div");
      div.className = `block ${type}`;
      div.textContent = label;
      div.dataset.type = type;
      div.dataset.habitat = habitat;

      if(type === "species"){
        const pureName = label.replace(/^[^\u4e00-\u9fa5]+/, ""); // å»æ‰å‰é¢çš„ emoji
        div.dataset.value = pureName;
      }else{
        div.dataset.value = label;
      }

      // PCï¼šåŸç”Ÿæ‹–æ‹½
      if (!isTouchDevice) {
        div.draggable = true;
        div.addEventListener("dragstart", e=>{
          const payload = {
            type,
            value: div.dataset.value,
            label,
            habitat
          };
          e.dataTransfer.setData("text/plain", JSON.stringify(payload));
        });
      }

      // æ‰‹æœºï¼šç‚¹å‡»æ·»åŠ åˆ°å½“å‰æ¿€æ´»è¡Œ
      if (isTouchDevice) {
        div.addEventListener("click", ()=>{
          addBlockToCanvas(type, div.dataset.value, label, activeCanvasId, habitat);
        });
      }

      return div;
    }

    function createCanvasBlock(type, value, label){
      const div = document.createElement("div");
      div.className = `block ${type}`;
      div.textContent = label;
      div.dataset.type = type;
      div.dataset.value = value;
      return div;
    }

    function addBlockToCanvas(type, value, label, areaId, blockHabitat){
      // æ£€æŸ¥å½“å‰æ¿€æ´»çš„æ¡†å±äºå“ªä¸ªæ –æ¯åœ°
      const [habitat, num] = areaId.split('-');
      
      // æ£€æŸ¥æ¨¡å—æ˜¯å¦å±äºæ­£ç¡®çš„æ –æ¯åœ°
      if (blockHabitat && blockHabitat !== habitat) {
        showToast(`è¿™ä¸ªç”Ÿç‰©å±äº${getHabitatName(blockHabitat)}ï¼Œä¸èƒ½æ·»åŠ åˆ°${getHabitatName(habitat)}çš„é£Ÿç‰©é“¾ä¸­ã€‚`, "error");
        return;
      }
      
      if(areaStates[areaId].hasSubmitted){
        showToast(`é£Ÿç‰©é“¾å·²ç»æäº¤è¿‡å•¦ï¼Œä¸èƒ½å†ä¿®æ”¹äº†ã€‚`,"error");
        return;
      }
      const canvasEl = document.getElementById(`canvas-${areaId}`);
      const node = createCanvasBlock(type, value, label);
      canvasEl.appendChild(node);
      updateCanvasEmptyState(areaId);
      updateCurrentChainDisplay(areaId);
      updateUndoButtons();
    }

    // è·å–æ –æ¯åœ°ä¸­æ–‡å
    function getHabitatName(habitat) {
      const names = {
        'forest': 'æ£®æ—',
        'grassland': 'è‰åŸ',
        'river': 'æ²³æµ'
      };
      return names[habitat] || habitat;
    }

    function updateCanvasEmptyState(areaId){
      const canvasEl = document.getElementById(`canvas-${areaId}`);
      if(canvasEl.children.length === 0){
        canvasEl.classList.add("empty");
      }else{
        canvasEl.classList.remove("empty");
      }
    }

    function parseCanvasSpeciesSequence(areaId){
      const canvasEl = document.getElementById(`canvas-${areaId}`);
      const arr = [];
      Array.from(canvasEl.children).forEach(child=>{
        if(child.dataset.type === "species"){
          arr.push(child.dataset.value);
        }
      });
      return arr;
    }

    function updateCurrentChainDisplay(areaId){
      const currentChainEl = document.getElementById(`currentChain-${areaId}`);
      const seq = parseCanvasSpeciesSequence(areaId);
      if(seq.length === 0){
        currentChainEl.textContent = "ï¼ˆè¿˜æ²¡æœ‰å“¦ï¼‰";
      }else{
        currentChainEl.textContent = seq.join("â†’");
      }
    }

    function initPalettes(){
      // åˆå§‹åŒ–ä¸‰ä¸ªæ –æ¯åœ°çš„æ¨¡å—åº“
      Object.keys(speciesList).forEach(habitat => {
        const paletteEl = document.getElementById(`palette-${habitat}`);
        
        // æ·»åŠ ç‰©ç§
        speciesList[habitat].forEach(s=>{
          paletteEl.appendChild(createPaletteBlock(s, "species", habitat));
        });
        
        // æ·»åŠ ç®­å¤´
        arrowList.forEach(a=>{
          paletteEl.appendChild(createPaletteBlock(a, "arrow", habitat));
        });
      });
    }

    // è®¾ç½®æ¿€æ´»æ¡†ï¼ˆæ‰‹æœºç‚¹å‡»æ¨¡å—æ—¶ç”¨ï¼‰
    function setActiveCanvas(areaId){
      activeCanvasId = areaId;
      
      // æ›´æ–°æ‰€æœ‰åŒºåŸŸçš„é«˜äº®çŠ¶æ€
      const allAreaIds = ['forest-1', 'forest-2', 'grassland-1', 'grassland-2', 'river-1', 'river-2'];
      allAreaIds.forEach(id=>{
        const areaEl = document.getElementById(`area-${id}`);
        if(id === areaId) {
          areaEl.classList.add("active");
        } else {
          areaEl.classList.remove("active");
        }
      });
    }

    function initCanvasDragDrop(){
      const allAreaIds = ['forest-1', 'forest-2', 'grassland-1', 'grassland-2', 'river-1', 'river-2'];
      
      allAreaIds.forEach(areaId=>{
        const canvasEl = document.getElementById(`canvas-${areaId}`);
        const areaEl = document.getElementById(`area-${areaId}`);

        // ç‚¹å‡»æ•´ä¸ªåŒºåŸŸï¼Œåˆ‡æ¢æ¿€æ´»è¡Œ
        areaEl.addEventListener("click", (e)=>{
          // é¿å…ç‚¹æŒ‰é’®æ—¶ä¹Ÿåˆ‡æ¢ï¼Œå¯ä»¥ç®€å•æ”¾å¼€ï¼šå°å­¦ç”Ÿå…¶å®æ— æ‰€è°“
          setActiveCanvas(areaId);
        });

        // PC æ‹–æ‹½æ”¾å…¥
        canvasEl.addEventListener("dragover", e=>e.preventDefault());
        canvasEl.addEventListener("drop", e=>{
          e.preventDefault();
          const text = e.dataTransfer.getData("text/plain");
          if(!text) return;
          let payload;
          try{ payload = JSON.parse(text); }catch{ return; }
          addBlockToCanvas(payload.type, payload.value, payload.label, areaId, payload.habitat);
        });
      });
    }

    function initAreaControls(areaId){
      const undoBtn = document.getElementById(`undoBtn-${areaId}`);
      const clearBtn = document.getElementById(`clearBtn-${areaId}`);
      const submitBtn = document.getElementById(`submitBtn-${areaId}`);

      undoBtn.addEventListener("click", ()=>{
        handleUndo(areaId);
      });

      clearBtn.addEventListener("click", ()=>{
        handleClear(areaId);
      });

      submitBtn.addEventListener("click", ()=>{
        handleSubmit(areaId);
      });
    }

    function handleUndo(areaId){
      if(areaStates[areaId].hasSubmitted) return;
      const canvasEl = document.getElementById(`canvas-${areaId}`);
      if(canvasEl.children.length > 0){
        canvasEl.removeChild(canvasEl.lastElementChild);
        updateCanvasEmptyState(areaId);
        updateCurrentChainDisplay(areaId);
        updateUndoButtons();
      }
    }

    function handleClear(areaId){
      if(areaStates[areaId].hasSubmitted) return;
      const canvasEl = document.getElementById(`canvas-${areaId}`);
      canvasEl.innerHTML = "";
      updateCanvasEmptyState(areaId);
      updateCurrentChainDisplay(areaId);
      updateUndoButtons();
    }

    function updateUndoButtons(){
      const allAreaIds = ['forest-1', 'forest-2', 'grassland-1', 'grassland-2', 'river-1', 'river-2'];
      
      allAreaIds.forEach(areaId=>{
        const canvasEl = document.getElementById(`canvas-${areaId}`);
        const undoBtn = document.getElementById(`undoBtn-${areaId}`);
        const clearBtn = document.getElementById(`clearBtn-${areaId}`);
        if(canvasEl.children.length === 0 || areaStates[areaId].hasSubmitted){
          undoBtn.disabled = true;
          clearBtn.disabled = true;
        }else{
          undoBtn.disabled = false;
          clearBtn.disabled = false;
        }
      });
    }

    function lockArea(areaId){
      areaStates[areaId].hasSubmitted = true;
      const submitBtn = document.getElementById(`submitBtn-${areaId}`);
      const undoBtn = document.getElementById(`undoBtn-${areaId}`);
      const clearBtn = document.getElementById(`clearBtn-${areaId}`);
      const canvasEl = document.getElementById(`canvas-${areaId}`);
      const submitHintEl = document.getElementById(`submitHint-${areaId}`);

      // æŒ‰é’®ç½®ç° + æ”¹æˆ"å·²æäº¤"ç»¿è‰²
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-check"></i> å·²æäº¤';
      submitBtn.classList.remove('btn-primary');
      submitBtn.classList.add('btn-success');

      undoBtn.disabled = true;
      clearBtn.disabled = true;
      canvasEl.classList.add("locked");

      if(submitHintEl){
        submitHintEl.textContent = "çŠ¶æ€ï¼šå·²æäº¤æˆåŠŸï¼Œè¯·ç­‰å¾…è€å¸ˆå±•ç¤ºå…¨ç­ç»“æœã€‚";
        submitHintEl.style.color = "#16a34a";
        submitHintEl.style.fontWeight = "bold";
      }
      updateUndoButtons();
    }


    /************ 4ï¼‰å­¦ç”Ÿç«¯ï¼šæäº¤åˆ° Supabaseï¼ˆæ¯ä¸ªæ¡†ä¸€æ¡è®°å½•ï¼‰ ************/
    async function handleSubmit(areaId){
      if(areaStates[areaId].hasSubmitted){
        showToast(`é£Ÿç‰©é“¾å·²ç»æäº¤è¿‡å•¦ï¼Œç­‰è€å¸ˆä¸€èµ·çœ‹ç»“æœå§ï¼`,"error");
        return;
      }
      if(areaStates[areaId].isSubmitting){
        showToast("æ­£åœ¨æäº¤ä¸­ï¼Œè¯·ç¨ç­‰å“¦ï½");
        return;
      }

      const seq = parseCanvasSpeciesSequence(areaId);
      if(seq.length < 2){
        showToast("è‡³å°‘è¦æœ‰ä¸¤ä¸ªç”Ÿç‰©æ‰èƒ½ç®—ä¸€æ¡é£Ÿç‰©é“¾å“¦ï½","error");
        return;
      }

      const nowMs = Date.now();
      const [habitat, num] = areaId.split('-');
      const habitatName = getHabitatName(habitat);
      
      const record = {
        chain_array: seq,
        chain_str: seq.join("â†’"),
        habitat: habitatName,
        habitat_type: habitat,
        date: new Date(nowMs).toLocaleDateString('zh-CN'),
        timestamp: nowMs
      };

      const submitBtn = document.getElementById(`submitBtn-${areaId}`);
      const originalHTML = submitBtn.innerHTML;
      areaStates[areaId].isSubmitting = true;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æäº¤â€¦';
      showToast(`æ­£åœ¨æäº¤${habitatName}é£Ÿç‰©é“¾ï¼Œè¯·ç¨ç­‰ï½`);

      const { error } = await supabase.from(TABLE_NAME).insert(record);

      if(error){
        console.error("æäº¤å¤±è´¥ï¼š", error);
        showToast("æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è®©è€å¸ˆå¸®å¿™ï½","error");
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalHTML;
        areaStates[areaId].isSubmitting = false;
        return;
      }

      if(seq.length < 3 || seq.length > 5){
        showToast(`${habitatName}é£Ÿç‰©é“¾æäº¤æˆåŠŸï¼ä¸‹æ¬¡å¯ä»¥è¯•è¯• 3ï½5 ä¸ªç”Ÿç‰©çš„é£Ÿç‰©é“¾ï½`);
      }else{
        showToast(`${habitatName}é£Ÿç‰©é“¾æäº¤æˆåŠŸï¼`);
      }
      lockArea(areaId);
      areaStates[areaId].isSubmitting = false;
    }

    /************ 5ï¼‰æ•™å¸ˆç«¯ï¼šç»Ÿè®¡ä¸æ±‡æ€»ï¼ˆæŒ‰æ –æ¯åœ°åˆ†ç»„ï¼‰ ************/
    const noDataTipEl = document.getElementById("noDataTip");
    const totalSubmissionsEl = document.getElementById("total-submissions");
    const uniqueChainsEl = document.getElementById("unique-chains");
    const todaySubmissionsEl = document.getElementById("today-submissions");
    const refreshBtn = document.getElementById("refresh-btn");
    const clearBtnTeacher = document.getElementById("clear-btn");

    // æŒ‰æ –æ¯åœ°è®¡ç®—æ±‡æ€»
    function computeSummaryByHabitat(records){
      const summary = {
        'æ£®æ—': {},
        'è‰åŸ': {},
        'æ²³æµ': {}
      };
      
      // ç»Ÿè®¡æ¯ä¸ªæ –æ¯åœ°çš„é£Ÿç‰©é“¾
      records.forEach(r=>{
        const habitat = r.habitat || "æœªçŸ¥æ –æ¯åœ°";
        const chain = r.chain_str || (Array.isArray(r.chain_array) ? r.chain_array.join("â†’") : "");
        
        if (!chain) return;
        
        // ç¡®ä¿æ –æ¯åœ°åœ¨æ±‡æ€»å¯¹è±¡ä¸­
        if (!summary[habitat]) {
          summary[habitat] = {};
        }
        
        // ç»Ÿè®¡è¯¥é£Ÿç‰©é“¾çš„å‡ºç°æ¬¡æ•°
        if (!summary[habitat][chain]) {
          summary[habitat][chain] = 0;
        }
        summary[habitat][chain] += 1;
      });
      
      return summary;
    }

    function getTodayCount(records){
      const today = new Date().toLocaleDateString('zh-CN');
      return records.filter(r => r.date === today).length;
    }

    // è®¡ç®—ä¸åŒé£Ÿç‰©é“¾æ€»æ•°
    function countUniqueChains(records){
      const uniqueChains = new Set();
      records.forEach(r=>{
        const chain = r.chain_str || (Array.isArray(r.chain_array) ? r.chain_array.join("â†’") : "");
        if (chain) {
          uniqueChains.add(chain);
        }
      });
      return uniqueChains.size;
    }

    function renderSummaryFromRecords(records){
      // æ›´æ–°ç»Ÿè®¡æ•°æ®
      totalSubmissionsEl.textContent = records.length;
      uniqueChainsEl.textContent = countUniqueChains(records);
      todaySubmissionsEl.textContent = getTodayCount(records);

      // æŒ‰æ –æ¯åœ°åˆ†ç»„è®¡ç®—
      const habitatSummary = computeSummaryByHabitat(records);
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
      let hasData = false;
      Object.keys(habitatSummary).forEach(habitat => {
        if (Object.keys(habitatSummary[habitat]).length > 0) {
          hasData = true;
        }
      });
      
      if (!hasData) {
        noDataTipEl.style.display = "block";
        // éšè—æ‰€æœ‰æ –æ¯åœ°æ±‡æ€»åŒºåŸŸ
        ['æ£®æ—', 'è‰åŸ', 'æ²³æµ'].forEach(habitat => {
          const summaryEl = document.getElementById(`summaryList-${getHabitatKey(habitat)}`);
          if (summaryEl) {
            summaryEl.innerHTML = '';
          }
        });
        return;
      } else {
        noDataTipEl.style.display = "none";
      }

      // æ¸²æŸ“æ¯ä¸ªæ –æ¯åœ°çš„æ±‡æ€»
      Object.keys(habitatSummary).forEach(habitat => {
        const habitatKey = getHabitatKey(habitat);
        const summaryListEl = document.getElementById(`summaryList-${habitatKey}`);
        
        if (summaryListEl) {
          summaryListEl.innerHTML = "";
          
          const chains = habitatSummary[habitat];
          if (Object.keys(chains).length === 0) {
            // è¯¥æ –æ¯åœ°æ²¡æœ‰æ•°æ®
            const li = document.createElement("li");
            li.textContent = "æš‚æ— æäº¤";
            li.style.fontStyle = "italic";
            li.style.color = "#999";
            li.style.fontWeight = "normal";
            summaryListEl.appendChild(li);
          } else {
            // æŒ‰å‡ºç°æ¬¡æ•°æ’åº
            const sortedChains = Object.entries(chains).sort((a, b) => b[1] - a[1]);
            
            sortedChains.forEach(([chain, count]) => {
              const li = document.createElement("li");
              li.textContent = `${chain}ï¼ˆ${count}ï¼‰`;
              summaryListEl.appendChild(li);
            });
          }
        }
      });
    }

    // è·å–æ –æ¯åœ°çš„é”®åï¼ˆè‹±æ–‡ï¼‰
    function getHabitatKey(habitatName) {
      const keys = {
        'æ£®æ—': 'forest',
        'è‰åŸ': 'grassland',
        'æ²³æµ': 'river'
      };
      return keys[habitatName] || habitatName;
    }

    async function fetchAndRender(){
      const { data, error } = await supabase
        .from(TABLE_NAME)
        .select('*')
        .order('timestamp', { ascending: false });

      if(error){
        console.error("åŠ è½½æ•°æ®å¤±è´¥ï¼š", error);
        showToast("æ•™å¸ˆç«¯åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•","error");
        return;
      }
      renderSummaryFromRecords(data || []);
    }

    // å®æ—¶è®¢é˜…
    const channel = supabase
      .channel('foodchains-change')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: TABLE_NAME },
        () => { fetchAndRender(); }
      )
      .subscribe();

    refreshBtn.addEventListener("click", async ()=>{
      await fetchAndRender();
      showToast("æ•°æ®å·²åˆ·æ–°ï¼");
    });

    clearBtnTeacher.addEventListener("click", async ()=>{
      if(!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é£Ÿç‰©é“¾è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) return;
      showToast("æ­£åœ¨æ¸…ç©ºæ•°æ®...");
      const { error } = await supabase
        .from(TABLE_NAME)
        .delete()
        .neq('id', '00000000-0000-0000-0000-000000000000');

      if(error){
        console.error("æ¸…ç©ºå¤±è´¥ï¼š", error);
        showToast("æ¸…ç©ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•","error");
        return;
      }
      await fetchAndRender();
      showToast("æ‰€æœ‰è®°å½•å·²æ¸…ç©ºï¼");
    });

    /************ 6ï¼‰å¯åŠ¨ï¼šåˆå§‹åŒ–å‰ç«¯ ************/
    initPalettes();
    initCanvasDragDrop();
    
    // åˆå§‹åŒ–æ‰€æœ‰åŒºåŸŸçš„æ§åˆ¶å’ŒçŠ¶æ€
    const allAreaIds = ['forest-1', 'forest-2', 'grassland-1', 'grassland-2', 'river-1', 'river-2'];
    allAreaIds.forEach(id=>{
      initAreaControls(id);
      updateCanvasEmptyState(id);
      updateCurrentChainDisplay(id);
    });
    
    setActiveCanvas('forest-1');
    updateUndoButtons();
    fetchAndRender();
  </script>
</body>
</html>



